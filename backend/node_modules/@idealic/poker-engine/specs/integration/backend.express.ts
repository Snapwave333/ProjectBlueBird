import express from 'express';
import * as Engine from '../../src';
import * as service from './backend';
import * as io from './backend.io';

service.setIO(io);

const app = express();
app.use(express.json());

/**
 * Single endpoint for poker game state management
 * Follows the stateless request-response pattern described in the spec
 *
 * This endpoint demonstrates the complete server-side flow for managing poker hands:
 * 1. Receives hand state from client
 * 2. Merges with server state
 * 3. Advances the game (dealer actions)
 * 4. Handles hand completion and transitions
 * 5. Returns personalized state to client
 */
app.post('/game/poker', async (req, res) => {
  try {
    // ============================================================
    // STEP 1: Parse and validate incoming hand from client
    // ============================================================
    // The client sends their current Hand state, which may contain new player actions
    let incomingHand: Engine.Hand;
    if (typeof req.body === 'string') {
      incomingHand = Engine.Format.JSON.parse(req.body);
    } else {
      incomingHand = req.body as Engine.Hand;
    }

    // ============================================================
    // STEP 2: Identify and authorize the requesting player
    // ============================================================
    try {
      io.authorizeRequest(req, incomingHand);
    } catch (error) {
      return res.status(403).json({ error: (error as Error).message });
    }

    // ============================================================
    // STEP 3: Process the poker request
    // ============================================================
    service.process(incomingHand);

    // Send a success response to prevent client timeout
    res.sendStatus(200);
  } catch (error) {
    console.error('Error processing poker request:', error);
    res.status(500).json({ error: 'An internal server error occurred.' });
  }
});

/**
 * Start timeout polling - runs every second
 * This would typically be a separate process/service
 */
export const timeoutPoller = setInterval(() => {
  io.checkGameTimeouts();
}, 1000);

// Start server
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  //console.log(`Poker game server running on port ${PORT}`);
});

export default app;
