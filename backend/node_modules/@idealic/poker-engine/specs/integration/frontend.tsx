import * as Poker from '@idealic/poker-engine';
import React, { useState } from 'react';

// This is the component that renders the poker game.
const GamePoker = ({ hand, game, playerIndex, activePlayerIndex, setGame }) => {
  const [clientTimer, setClientTimer] = useState(Poker.Hand.getTimeLeft(hand));
  // action flags
  const checkAction = Poker.Command.check(game, playerIndex);
  const foldAction = Poker.Command.fold(game, playerIndex);
  const callAction = Poker.Command.call(game, playerIndex);
  const betAction = Poker.Command.bet(game, playerIndex, 100);
  const canCheck = Poker.Game.canApplyAction(game, checkAction);
  const canFold = Poker.Game.canApplyAction(game, foldAction);
  const canBet = Poker.Game.canApplyAction(game, betAction);

  function handleAction(playerAction: Poker.Action) {
    // apply action to the Hand state
    const newHand = hand.applyAction(playerAction);
    // stop UI timer
    setClientTimer(0);
    // Send it to the server
    //sendHandToServer(newHand);
    // update parent game state
    setGame(Poker.Game(newHand));
  }

  return (
    <div>
      {/* Board Cards Section */}
      <div>
        <h2>Board</h2>
        <p>Community Cards: {game.board.join(' ') || 'No cards dealt yet'}</p>
      </div>

      {/* Pot Section */}
      <div>
        <h2>Pot</h2>
        <p>Total Pot: ${game.pot}</p>
      </div>

      {/* Table Section */}
      <div>
        <h2>Players</h2>
        {game.players.map((player, index) => (
          <div key={index}>
            <h3>
              {player.name} {index === activePlayerIndex && '(Current Player)'}
              {player.isAllIn && '(All-in)'}
              {player.hasFolded && '(Folded)'}
            </h3>
            {index === activePlayerIndex && <p>Time left: {clientTimer} ms</p>}
            <p>Stack: ${player.stack}</p>
            <p>Current Bet: ${player.currentBet}</p>
            <p>Cards: {player.cards.join(', ')}</p>
          </div>
        ))}
      </div>

      {/* Player actions section */}
      <div>
        <h2>Actions</h2>
        <button onClick={() => handleAction(foldAction)} disabled={!canFold}>
          Fold
        </button>
        <button onClick={() => handleAction(callAction)} disabled={!canCheck}>
          Check
        </button>
        <button onClick={() => handleAction(betAction)} disabled={!canBet}>
          Bet
        </button>
      </div>
    </div>
  );
};

// This is the component that manages the game state.
const Game = ({ initialHand, author }) => {
  // Create the initial game state from the hand.
  const [game, setGame] = useState(Poker.Game(initialHand));

  // Get the index of the currently active player.
  const activePlayerIndex = Poker.Game.getCurrentPlayerIndex(game);

  // Find the index of the current player based on the author of the hand.
  const playerIndex = Poker.Game.getPlayerIndex(game, author);

  // Renders the poker game component with the necessary props.
  return (
    <GamePoker
      hand={initialHand}
      game={game}
      activePlayerIndex={activePlayerIndex}
      playerIndex={playerIndex}
      setGame={setGame}
    />
  );
};

// Example of how to use the Game component.
const App = () => {
  // The initial hand, representing the state of the game.
  const initialHand: Poker.Hand = {
    author: 'John',
    variant: 'NT',
    players: ['John', 'Alice', 'Bob'],
    startingStacks: [1000, 1000, 1000],
    blindsOrStraddles: [0, 10, 20],
    antes: [],
    actions: ['d dh p1 Ac Ad', 'd dh p2 Kh Ks', 'd dh p3 Qs Qc'],
    minBet: 20,
  };

  // The author is the player from whose perspective we are viewing the game.
  return <Game initialHand={initialHand} author="John" />;
};
